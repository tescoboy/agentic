{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3">Products - {{ tenant.name }}</h1>
            <p class="text-muted">Manage products for {{ tenant.name }}</p>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                <a href="/tenant/{{ tenant.id }}/products/add" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Product
                </a>
                <a href="/tenant/{{ tenant.id }}/agent" class="btn btn-outline-primary">
                    <i class="fas fa-robot"></i> AI Settings
                </a>
            </div>
        </div>
    </div>

    <!-- Error Messages -->
    {% if error %}
    <div class="alert alert-danger" role="alert">
        <h5 class="alert-heading">Error</h5>
        <p>{{ error }}</p>
        {% if error_details %}
        <hr>
        <ul class="mb-0">
            {% for detail in error_details %}
            <li>{{ detail }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    {% endif %}

    <!-- Success Messages -->
    {% if request.query_params.get('message') %}
    <div class="alert alert-success" role="alert">
        {{ request.query_params.get('message') }}
    </div>
    {% endif %}

    <!-- Search and Actions -->
    <div class="row mb-3">
        <div class="col-md-6">
            <form method="GET" class="d-flex">
                <input type="hidden" name="sort" value="{{ sort }}">
                <input type="hidden" name="order" value="{{ order }}">
                <input type="hidden" name="page" value="1">
                <input type="hidden" name="size" value="{{ size }}">
                <input type="text" name="q" value="{{ query or '' }}" class="form-control me-2" 
                       placeholder="Search products...">
                <button type="submit" class="btn btn-outline-secondary">
                    <i class="fas fa-search"></i>
                </button>
                {% if query %}
                <a href="/tenant/{{ tenant.id }}/products" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-times"></i>
                </a>
                {% endif %}
            </form>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group" role="group">
                <a href="/tenant/{{ tenant.id }}/products/template.csv" class="btn btn-outline-secondary">
                    <i class="fas fa-download"></i> Download Template
                </a>
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="fas fa-upload"></i> Bulk Upload
                </button>
                {% if total > 0 %}
                <a href="/tenant/{{ tenant.id }}/products/bulk-delete" class="btn btn-outline-danger">
                    <i class="fas fa-trash"></i> Bulk Delete
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Products Table -->
    {% if products %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>
                        <a href="?sort=product_id&order={% if sort == 'product_id' and order == 'asc' %}desc{% else %}asc{% endif %}&q={{ query or '' }}&page={{ page }}&size={{ size }}" 
                           class="text-decoration-none text-dark">
                            Product ID
                            {% if sort == 'product_id' %}
                            <i class="fas fa-sort-{% if order == 'asc' %}up{% else %}down{% endif %}"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?sort=name&order={% if sort == 'name' and order == 'asc' %}desc{% else %}asc{% endif %}&q={{ query or '' }}&page={{ page }}&size={{ size }}" 
                           class="text-decoration-none text-dark">
                            Name
                            {% if sort == 'name' %}
                            <i class="fas fa-sort-{% if order == 'asc' %}up{% else %}down{% endif %}"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th>Description</th>
                    <th>
                        <a href="?sort=delivery_type&order={% if sort == 'delivery_type' and order == 'asc' %}desc{% else %}asc{% endif %}&q={{ query or '' }}&page={{ page }}&size={{ size }}" 
                           class="text-decoration-none text-dark">
                            Delivery Type
                            {% if sort == 'delivery_type' %}
                            <i class="fas fa-sort-{% if order == 'asc' %}up{% else %}down{% endif %}"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?sort=cpm&order={% if sort == 'cpm' and order == 'asc' %}desc{% else %}asc{% endif %}&q={{ query or '' }}&page={{ page }}&size={{ size }}" 
                           class="text-decoration-none text-dark">
                            CPM
                            {% if sort == 'cpm' %}
                            <i class="fas fa-sort-{% if order == 'asc' %}up{% else %}down{% endif %}"></i>
                            {% endif %}
                        </a>
                    </th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr>
                    <td><code>{{ product.product_id }}</code></td>
                    <td>{{ product.name }}</td>
                    <td>
                        <div class="text-truncate" style="max-width: 300px;" title="{{ product.description }}">
                            {{ product.description }}
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-{% if product.delivery_type == 'guaranteed' %}success{% else %}warning{% endif %}">
                            {{ product.delivery_type }}
                        </span>
                    </td>
                    <td>
                        {% if product.cpm %}
                        ${{ "%.2f"|format(product.cpm) }}
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="/tenant/{{ tenant.id }}/products/{{ product.id }}/edit" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form method="POST" action="/tenant/{{ tenant.id }}/products/{{ product.id }}/delete" 
                                  class="d-inline" onsubmit="return confirm('Are you sure you want to delete this product?')">
                                <button type="submit" class="btn btn-outline-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <nav aria-label="Products pagination">
        <ul class="pagination justify-content-center">
            {% if page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page - 1 }}&size={{ size }}&q={{ query or '' }}&sort={{ sort }}&order={{ order }}">
                    Previous
                </a>
            </li>
            {% endif %}
            
            {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="?page={{ p }}&size={{ size }}&q={{ query or '' }}&sort={{ sort }}&order={{ order }}">
                    {{ p }}
                </a>
            </li>
            {% endfor %}
            
            {% if page < total_pages %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page + 1 }}&size={{ size }}&q={{ query or '' }}&sort={{ sort }}&order={{ order }}">
                    Next
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    <!-- Results Summary -->
    <div class="text-muted text-center">
        Showing {{ (page - 1) * size + 1 }} to {{ (page * size) if (page * size) < total else total }} of {{ total }} products
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="text-center py-5">
        <i class="fas fa-box fa-3x text-muted mb-3"></i>
        <h4>No products found</h4>
        <p class="text-muted">
            {% if query %}
            No products match your search criteria.
            {% else %}
            Get started by adding your first product.
            {% endif %}
        </p>
        <a href="/tenant/{{ tenant.id }}/products/add" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Product
        </a>
    </div>
    {% endif %}
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Upload Products</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/tenant/{{ tenant.id }}/products/bulk-upload" enctype="multipart/form-data" data-log="true">
                <div class="modal-body">
                    <p>Upload a CSV file with product data. Download the template first to see the required format.</p>
                    <div class="mb-3">
                        <label for="file" class="form-label">CSV File</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
